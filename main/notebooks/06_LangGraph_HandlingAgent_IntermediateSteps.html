<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>LangGraph Handling LangChain Agent Intermediate_Steps &mdash; NVIDIA Generative AI Examples 24.6.0 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" type="text/css" />
      <link rel="stylesheet" href="../_static/copybutton.css" type="text/css" />
      <link rel="stylesheet" href="../_static/omni-style.css" type="text/css" />
      <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/clipboard.min.js"></script>
        <script src="../_static/copybutton.js"></script>
        <script src="../_static/version.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Notebook: Chatting with NVIDIA Financial Reports" href="07_Chat_with_nvidia_financial_reports.html" />
    <link rel="prev" title="Build a RAG chain by generating embeddings for NVIDIA Triton documentation" href="05_RAG_for_HTML_docs_with_Langchain_NVIDIA_AI_Endpoints.html" />
 


</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >


<a href="../index.html">
  <img src="../_static/nvidia-logo-white.png" class="logo" alt="Logo"/>
</a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">RAG Pipelines for Developers</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../index.html">About the RAG Pipelines</a></li>
<li class="toctree-l1"><a class="reference internal" href="../support-matrix.html">Support Matrix</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api-catalog.html">API Catalog Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../query-decomposition.html">Query Decomposition</a></li>
<li class="toctree-l1"><a class="reference internal" href="../structured-data.html">Structured Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../multimodal-data.html">Multimodal Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../multi-turn.html">Multi-turn</a></li>
<li class="toctree-l1"><a class="reference internal" href="../using-sample-web-application.html">Sample Chat Application</a></li>
<li class="toctree-l1"><a class="reference internal" href="../vector-database.html">Alternative Vector Database</a></li>
<li class="toctree-l1"><a class="reference internal" href="../nim-llms.html">NIM for LLMs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../simple-examples.html">Developing Simple Examples</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Tools</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../tools/evaluation/index.html">Evaluation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../observability.html">Observability</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Jupyter Notebooks</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="01_dataloader.html">Press Release Chat Bot</a></li>
<li class="toctree-l1"><a class="reference internal" href="02_Option%281%29_NVIDIA_AI_endpoint_simple.html">NVIDIA API Catalog with LangChain</a></li>
<li class="toctree-l1"><a class="reference internal" href="02_Option%282%29_minimalistic_RAG_with_langchain_local_HF_LLM.html">LangChain with Local Llama 2 Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="03_Option%281%29_llama_index_with_NVIDIA_AI_endpoint.html">NVIDIA API Catalog, LlamaIndex, and LangChain</a></li>
<li class="toctree-l1"><a class="reference internal" href="03_Option%282%29_llama_index_with_HF_local_LLM.html">HF Checkpoints with LlamaIndex and LangChain</a></li>
<li class="toctree-l1"><a class="reference internal" href="04_Agent_use_tools_leveraging_NVIDIA_AI_endpoints.html">Multimodal Models from NVIDIA AI Catelog and AI Catalog with LangChain Agent</a></li>
<li class="toctree-l1"><a class="reference internal" href="05_RAG_for_HTML_docs_with_Langchain_NVIDIA_AI_Endpoints.html">Build a RAG chain by generating embeddings for NVIDIA Triton documentation</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">LangGraph Handling LangChain Agent Intermediate_Steps</a></li>
<li class="toctree-l1"><a class="reference internal" href="07_Chat_with_nvidia_financial_reports.html">Notebook: Chatting with NVIDIA Financial Reports</a></li>
<li class="toctree-l1"><a class="reference internal" href="08_RAG_Langchain_with_Local_NIM.html">Build a RAG using a locally hosted NIM</a></li>
<li class="toctree-l1"><a class="reference internal" href="agentic_rag_with_nemo_retriever_nims.html">Agentic RAG pipeline with Nemo Retriever and LLM NIMs</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Software Components</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../architecture.html">Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../frontend.html">RAG Playground Web Application</a></li>
<li class="toctree-l1"><a class="reference internal" href="../jupyter-server.html">Jupyter Notebook Server</a></li>
<li class="toctree-l1"><a class="reference internal" href="../chain-server.html">Chain Server</a></li>
<li class="toctree-l1"><a class="reference internal" href="../configuration.html">Software Component Configuration</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">NVIDIA Generative AI Examples</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
      <li>LangGraph Handling LangChain Agent Intermediate_Steps</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section class="tex2jax_ignore mathjax_ignore" id="langgraph-handling-langchain-agent-intermediate-steps">
<h1>LangGraph Handling LangChain Agent Intermediate_Steps<a class="headerlink" href="#langgraph-handling-langchain-agent-intermediate-steps" title="Permalink to this headline"></a></h1>
<p>In this notebook we will learn how to build a basic <a class="reference external" href="https://api.python.langchain.com/en/latest/agents/langchain.agents.agent.AgentExecutor.html">agent executor</a> leveraging <a class="reference external" href="https://github.com/langchain-ai/langgraph">langGraph</a>.</p>
<p>We demonstrate how to handle the logic of the intermediate steps from the agent leveraging different provided tools within langGraph.</p>
<ul class="simple">
<li><p>We will be leveraging LLM <a class="reference external" href="https://build.nvidia.com/mistralai/mixtral-8x7b-instruct">ai-mixtral-8x7b-instruct from NVIDIA API Catalog</a>.</p></li>
<li><p>Simple Faiss Retriever as one of the tools with the <a class="reference external" href="https://build.nvidia.com/nvidia/embed-qa-4">ai-embed-qa-4 from NVIDIA API Catalog</a>.</p></li>
<li><p>Wikipedia (the pip installable package) as one of the tools.</p></li>
</ul>
<p>Then we will utilize with LangGraph to control and intervene intermediate steps as well as the outputs from the agent.</p>
<section id="prerequisites">
<h2>Prerequisites<a class="headerlink" href="#prerequisites" title="Permalink to this headline"></a></h2>
<p>To run this notebook, you need the following:</p>
<ol class="arabic simple">
<li><p>Already completed the <a class="reference external" href="https://python.langchain.com/docs/integrations/text_embedding/nvidia_ai_endpoints#setup">setup</a> and generated an API key.</p></li>
<li><p>Installed necesary Python dependencies in <a class="reference external" href="https://github.com/NVIDIA/GenerativeAIExamples/blob/main/notebooks/requirements.txt">requirements.txt</a></p></li>
</ol>
<p>Change <code class="docutils literal notranslate"><span class="pre">faiss-gpu</span></code> to <code class="docutils literal notranslate"><span class="pre">faiss-cpu</span></code> in the <code class="docutils literal notranslate"><span class="pre">requirements.txt</span></code> file if you do not have access to a GPU.</p>
</section>
<section id="install-additional-python-packages">
<h2>Install additional Python packages<a class="headerlink" href="#install-additional-python-packages" title="Permalink to this headline"></a></h2>
<p>Install the additional packages that required for this example, assuming that installed all the python packages from the <a class="reference external" href="https://github.com/NVIDIA/GenerativeAIExamples/blob/main/notebooks/requirements.txt">requirements.txt</a> file.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>pip<span class="w"> </span>install<span class="w"> </span>--upgrade<span class="w"> </span>pip
<span class="o">!</span>pip<span class="w"> </span>install<span class="w"> </span><span class="nv">wikipedia</span><span class="o">==</span><span class="m">1</span>.4.0
<span class="o">!</span>pip<span class="w"> </span>install<span class="w"> </span>langchain-community<span class="o">==</span><span class="m">0</span>.2.2
<span class="o">!</span>pip<span class="w"> </span>install<span class="w"> </span><span class="nv">langchain</span><span class="o">==</span><span class="m">0</span>.2.2
<span class="o">!</span>pip<span class="w"> </span>install<span class="w"> </span><span class="nv">langgraph</span><span class="o">==</span><span class="m">0</span>.0.62
<span class="o">!</span>pip<span class="w"> </span>install<span class="w"> </span>faiss-gpu<span class="o">==</span><span class="m">1</span>.7.2
</pre></div>
</div>
</div>
</div>
</section>
<section id="step-1-export-the-nvidia-api-key">
<h2>Step 1  - Export the NVIDIA_API_KEY<a class="headerlink" href="#step-1-export-the-nvidia-api-key" title="Permalink to this headline"></a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">getpass</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="c1">## API Key can be found by going to NVIDIA NGC -&gt; AI Foundation Models -&gt; (some model) -&gt; Get API Code or similar.</span>
<span class="c1">## 10K free queries to any endpoint (which is a lot actually).</span>

<span class="c1"># del os.environ[&#39;NVIDIA_API_KEY&#39;]  ## delete key and reset</span>
<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;NVIDIA_API_KEY&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;nvapi-&quot;</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Valid NVIDIA_API_KEY already in environment. Delete to reset&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">nvapi_key</span> <span class="o">=</span> <span class="n">getpass</span><span class="o">.</span><span class="n">getpass</span><span class="p">(</span><span class="s2">&quot;NVAPI Key (starts with nvapi-): &quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">nvapi_key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;nvapi-&quot;</span><span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">nvapi_key</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span><span class="si">}</span><span class="s2">... is not a valid key&quot;</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;NVIDIA_API_KEY&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nvapi_key</span>
</pre></div>
</div>
</div>
</div>
<p>Optionally, we can set API key for <a class="reference external" href="https://smith.langchain.com/">LangSmith tracing</a>, which will give us best-in-class observability.</p>
</section>
<section id="step-2-initialize-the-llm-and-embedding-models">
<h2>Step 2 - Initialize the LLM and embedding models<a class="headerlink" href="#step-2-initialize-the-llm-and-embedding-models" title="Permalink to this headline"></a></h2>
<p>The following code sets ai-mixtral-8x7b-instruct as the main LLM and ai-embed-qa-4 as the embedding model.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">langchain.vectorstores</span> <span class="kn">import</span> <span class="n">FAISS</span>

<span class="kn">from</span> <span class="nn">langchain_nvidia_ai_endpoints</span> <span class="kn">import</span> <span class="n">ChatNVIDIA</span>
<span class="kn">from</span> <span class="nn">langchain_nvidia_ai_endpoints</span> <span class="kn">import</span> <span class="n">NVIDIAEmbeddings</span>

<span class="n">llm</span> <span class="o">=</span> <span class="n">ChatNVIDIA</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="s2">&quot;mistralai/mixtral-8x7b-instruct-v0.1&quot;</span><span class="p">,</span> <span class="n">nvidia_api_key</span><span class="o">=</span><span class="n">nvapi_key</span><span class="p">,</span> <span class="n">max_tokens</span><span class="o">=</span><span class="mi">2048</span><span class="p">)</span>
<span class="n">embedder</span> <span class="o">=</span> <span class="n">NVIDIAEmbeddings</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="s2">&quot;NV-Embed-QA&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="step-3-retriever-from-faiss-vector-store">
<h2>Step 3 - Retriever from FAISS vector store<a class="headerlink" href="#step-3-retriever-from-faiss-vector-store" title="Permalink to this headline"></a></h2>
<p>We need to process a toy example, here we use <code class="docutils literal notranslate"><span class="pre">Sweden.txt</span></code> from the <code class="docutils literal notranslate"><span class="pre">toy_data</span></code> folder.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span> <span class="nn">faiss</span>
<span class="kn">from</span> <span class="nn">operator</span> <span class="kn">import</span> <span class="n">itemgetter</span>
<span class="kn">from</span> <span class="nn">langchain.vectorstores</span> <span class="kn">import</span> <span class="n">FAISS</span>
<span class="kn">from</span> <span class="nn">langchain_core.output_parsers</span> <span class="kn">import</span> <span class="n">StrOutputParser</span>
<span class="kn">from</span> <span class="nn">langchain_core.prompts</span> <span class="kn">import</span> <span class="n">ChatPromptTemplate</span>
<span class="kn">from</span> <span class="nn">langchain_core.runnables</span> <span class="kn">import</span> <span class="n">RunnablePassthrough</span>
<span class="kn">from</span> <span class="nn">langchain.text_splitter</span> <span class="kn">import</span> <span class="n">CharacterTextSplitter</span>
<span class="kn">from</span> <span class="nn">langchain_nvidia_ai_endpoints</span> <span class="kn">import</span> <span class="n">ChatNVIDIA</span>
<span class="kn">import</span> <span class="nn">faiss</span>

<span class="c1"># We need to process the text data and prepare them.</span>
<span class="n">p</span> <span class="o">=</span> <span class="s2">&quot;Sweden.txt&quot;</span>
<span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">sources</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">path2file</span> <span class="o">=</span> <span class="s2">&quot;./toy_data/&quot;</span> <span class="o">+</span> <span class="n">p</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path2file</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="n">sources</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path2file</span><span class="p">)</span>
<span class="n">documents</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span> <span class="k">if</span> <span class="n">d</span> <span class="o">!=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">]</span>

<span class="c1"># create docs and metadatas</span>
<span class="n">text_splitter</span> <span class="o">=</span> <span class="n">CharacterTextSplitter</span><span class="p">(</span><span class="n">chunk_size</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">separator</span><span class="o">=</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
<span class="n">docs</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">metadatas</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">documents</span><span class="p">):</span>
    <span class="n">splits</span> <span class="o">=</span> <span class="n">text_splitter</span><span class="o">.</span><span class="n">split_text</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
    <span class="n">docs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">splits</span><span class="p">)</span>
    <span class="n">metadatas</span><span class="o">.</span><span class="n">extend</span><span class="p">([{</span><span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="n">sources</span><span class="p">[</span><span class="n">i</span><span class="p">]}]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">splits</span><span class="p">))</span>

<span class="c1"># you only need to do this once, in the future, when re-run this notebook, skip to below and load the vector store from disk</span>
<span class="n">store</span> <span class="o">=</span> <span class="n">FAISS</span><span class="o">.</span><span class="n">from_texts</span><span class="p">(</span><span class="n">docs</span><span class="p">,</span> <span class="n">embedder</span> <span class="p">,</span> <span class="n">metadatas</span><span class="o">=</span><span class="n">metadatas</span><span class="p">)</span>
<span class="n">store</span><span class="o">.</span><span class="n">save_local</span><span class="p">(</span><span class="s1">&#39;/workspace/save_embedding/sv&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">## If you previously preprocessed and saved the vector store to disk, then reload it here</span>
<span class="n">faissDB</span> <span class="o">=</span> <span class="n">FAISS</span><span class="o">.</span><span class="n">load_local</span><span class="p">(</span><span class="s2">&quot;/workspace/save_embedding/sv&quot;</span><span class="p">,</span> <span class="n">embedder</span><span class="p">,</span> <span class="n">allow_dangerous_deserialization</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">retriever</span> <span class="o">=</span> <span class="n">faissDB</span><span class="o">.</span><span class="n">as_retriever</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="step-4-construct-a-retriever-for-sweden-data">
<h2>Step 4 - Construct a Retriever for Sweden data<a class="headerlink" href="#step-4-construct-a-retriever-for-sweden-data" title="Permalink to this headline"></a></h2>
<p>The following code creates a <code class="docutils literal notranslate"><span class="pre">SwedenRetriever</span></code> class that inherits from LangChain’s <code class="docutils literal notranslate"><span class="pre">BaseTool</span></code> class.</p>
<p>We’ll use the class as a tool for retrieving data about Sweden to augment responses.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">langchain.tools</span> <span class="kn">import</span> <span class="n">BaseTool</span>

<span class="k">class</span> <span class="nc">SwedenRetriever</span><span class="p">(</span><span class="n">BaseTool</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;AboutSweden&quot;</span>
    <span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;Useful for when you need to answer questions about Sweden&#39;s population, history, and so on.&quot;</span>

    <span class="k">def</span> <span class="nf">_run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">retriever</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="n">o</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">item</span><span class="o">=</span><span class="n">o</span><span class="o">.</span><span class="n">page_content</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="p">)</span>
        <span class="n">output</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">output</span>

    <span class="k">def</span> <span class="nf">_arun</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;This tool does not support async&quot;</span><span class="p">)</span>
<span class="n">sv</span><span class="o">=</span><span class="n">SwedenRetriever</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="step-5-construct-wikipedia-as-the-second-tool">
<h2>Step 5 - Construct wikipedia as the second tool<a class="headerlink" href="#step-5-construct-wikipedia-as-the-second-tool" title="Permalink to this headline"></a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">langchain_community.tools.wikipedia.tool</span> <span class="kn">import</span> <span class="n">WikipediaQueryRun</span>
<span class="kn">from</span> <span class="nn">langchain_community.utilities</span> <span class="kn">import</span> <span class="n">WikipediaAPIWrapper</span>

<span class="n">wikipedia</span> <span class="o">=</span> <span class="n">WikipediaQueryRun</span><span class="p">(</span><span class="n">api_wrapper</span><span class="o">=</span><span class="n">WikipediaAPIWrapper</span><span class="p">())</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="step-6-give-your-tools-a-good-name-and-populate-the-description">
<h2>Step 6 - Give your tools a good name and populate the description<a class="headerlink" href="#step-6-give-your-tools-a-good-name-and-populate-the-description" title="Permalink to this headline"></a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">langchain.tools</span> <span class="kn">import</span> <span class="n">Tool</span>

<span class="c1">## Make sure you give it a proper name and a good description on how to use the tools</span>
<span class="n">wiki_tool</span> <span class="o">=</span> <span class="n">Tool</span><span class="o">.</span><span class="n">from_function</span><span class="p">(</span>
    <span class="n">func</span><span class="o">=</span><span class="n">wikipedia</span><span class="o">.</span><span class="n">run</span><span class="p">,</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Wiki&quot;</span><span class="p">,</span>
    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;useful for when you need to search certain topic on Wikipedia, aka wiki&quot;</span><span class="p">)</span>
<span class="n">retriever_tool</span><span class="o">=</span><span class="n">Tool</span><span class="o">.</span><span class="n">from_function</span><span class="p">(</span>
    <span class="n">func</span><span class="o">=</span><span class="n">sv</span><span class="o">.</span><span class="n">invoke</span><span class="p">,</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;AboutSweden&quot;</span><span class="p">,</span>
    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;useful for when you need to find information about Sweden&quot;</span><span class="p">)</span>

<span class="n">tools</span> <span class="o">=</span> <span class="p">[</span><span class="n">wiki_tool</span><span class="p">,</span> <span class="n">retriever_tool</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="step-7-wrap-tools-into-toolexecutor">
<h2>Step 7 - Wrap tools into ToolExecutor<a class="headerlink" href="#step-7-wrap-tools-into-toolexecutor" title="Permalink to this headline"></a></h2>
<p>We will use these ToolExecutor to invoke tool in LangGraph nodes later on.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">langchain_core.agents</span> <span class="kn">import</span> <span class="n">AgentFinish</span>
<span class="kn">from</span> <span class="nn">langgraph.prebuilt.tool_executor</span> <span class="kn">import</span> <span class="n">ToolExecutor</span>

<span class="c1"># This a helper class we have that is useful for running tools</span>
<span class="c1"># It takes in an agent action and calls that tool and returns the result</span>
<span class="n">tool_executor</span> <span class="o">=</span> <span class="n">ToolExecutor</span><span class="p">(</span><span class="n">tools</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="step-8-create-the-prompt-template-and-conversation-memory">
<h2>Step 8 - Create the prompt template and conversation memory<a class="headerlink" href="#step-8-create-the-prompt-template-and-conversation-memory" title="Permalink to this headline"></a></h2>
<p>The following code creates a memory buffer for storing queries and responses.
It also demonstrates how to write a prompt template for a Mistral mode that uses conversation memory and the Wiki and retriever tools.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">langchain.agents</span> <span class="kn">import</span> <span class="n">AgentExecutor</span>
<span class="kn">from</span> <span class="nn">langchain.agents</span> <span class="kn">import</span> <span class="n">initialize_agent</span>
<span class="kn">from</span> <span class="nn">langchain.prompts</span> <span class="kn">import</span> <span class="n">MessagesPlaceholder</span>
<span class="kn">from</span> <span class="nn">langchain.memory</span> <span class="kn">import</span> <span class="n">ConversationBufferMemory</span>
<span class="kn">from</span> <span class="nn">langchain.agents</span> <span class="kn">import</span> <span class="n">AgentType</span><span class="p">,</span> <span class="n">Agent</span><span class="p">,</span> <span class="n">ConversationalAgent</span>
<span class="kn">from</span> <span class="nn">langchain_core.prompts</span> <span class="kn">import</span> <span class="n">ChatPromptTemplate</span><span class="p">,</span> <span class="n">PromptTemplate</span>

<span class="c1">## set up memory</span>
<span class="n">memory</span> <span class="o">=</span> <span class="n">ConversationBufferMemory</span><span class="p">(</span><span class="n">memory_key</span><span class="o">=</span><span class="s2">&quot;chat_history&quot;</span><span class="p">,</span> <span class="n">input_key</span><span class="o">=</span><span class="s1">&#39;input&#39;</span><span class="p">,</span> <span class="n">output_key</span><span class="o">=</span><span class="s2">&quot;output&quot;</span><span class="p">)</span>


<span class="n">prompt_template</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">### [INST]</span>

<span class="s2">Assistant is a large language model trained by Mistral.</span>

<span class="s2">Assistant is designed to be able to assist with a wide range of tasks, from answering simple questions to providing in-depth explanations and discussions on a wide range of topics. As a language model, Assistant is able to generate human-like text based on the input it receives, allowing it to engage in natural-sounding conversations and provide responses that are coherent and relevant to the topic at hand.</span>

<span class="s2">Assistant is constantly learning and improving, and its capabilities are constantly evolving. It is able to process and understand large amounts of text, and can use this knowledge to provide accurate and informative responses to a wide range of questions. Additionally, Assistant is able to generate its own text based on the input it receives, allowing it to engage in discussions and provide explanations and descriptions on a wide range of topics.</span>

<span class="s2">Overall, Assistant is a powerful tool that can help with a wide range of tasks and provide valuable insights and information on a wide range of topics. Whether you need help with a specific question or just want to have a conversation about a particular topic, Assistant is here to assist.</span>

<span class="s2">Context:</span>
<span class="s2">------</span>

<span class="s2">Assistant has access to the following tools:</span>

<span class="si">{tools}</span>

<span class="s2">To use a tool, please use the following format:</span>

<span class="s2">&#39;&#39;&#39;</span>
<span class="s2">Thought: Do I need to use a tool? Yes</span>
<span class="s2">Action: the action to take, should be one of [</span><span class="si">{tool_names}</span><span class="s2">]</span>
<span class="s2">Action Input: the input to the action</span>
<span class="s2">Observation: the result of the action</span>
<span class="s2">&#39;&#39;&#39;</span>

<span class="s2">When you have a response to say to the Human, or if you do not need to use a tool, you MUST use the format:</span>

<span class="s2">&#39;&#39;&#39;</span>
<span class="s2">Thought: Do I need to use a tool? No</span>
<span class="s2">Final Answer: [your response here]</span>
<span class="s2">&#39;&#39;&#39;</span>

<span class="s2">Begin!</span>

<span class="s2">Previous conversation history:</span>
<span class="si">{chat_history}</span>

<span class="s2">New input: </span><span class="si">{input}</span>

<span class="s2">Current Scratchpad:</span>
<span class="si">{agent_scratchpad}</span>

<span class="s2">[/INST]</span>
<span class="s2"> &quot;&quot;&quot;</span>

<span class="c1"># Create prompt from prompt template</span>
<span class="n">prompt</span> <span class="o">=</span> <span class="n">PromptTemplate</span><span class="p">(</span>
    <span class="n">input_variables</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;agent_scratchpad&#39;</span><span class="p">,</span> <span class="s1">&#39;chat_history&#39;</span><span class="p">,</span> <span class="s1">&#39;input&#39;</span><span class="p">,</span> <span class="s1">&#39;tool_names&#39;</span><span class="p">,</span> <span class="s1">&#39;tools&#39;</span><span class="p">],</span>
    <span class="n">template</span><span class="o">=</span><span class="n">prompt_template</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">prompt</span> <span class="o">=</span> <span class="n">prompt</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span>
    <span class="n">tools</span><span class="o">=</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tools</span><span class="p">],</span>
    <span class="n">tool_names</span><span class="o">=</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">t</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tools</span><span class="p">]),</span>
<span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;prompt ---&gt; </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">prompt</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="step-9-establish-agent-executor-using-langchain">
<h2>Step 9 - Establish agent executor using LangChain<a class="headerlink" href="#step-9-establish-agent-executor-using-langchain" title="Permalink to this headline"></a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Sequence</span>

<span class="kn">from</span> <span class="nn">langchain_core._api</span> <span class="kn">import</span> <span class="n">deprecated</span>
<span class="kn">from</span> <span class="nn">langchain_core.callbacks</span> <span class="kn">import</span> <span class="n">BaseCallbackManager</span>
<span class="kn">from</span> <span class="nn">langchain_core.language_models</span> <span class="kn">import</span> <span class="n">BaseLanguageModel</span>
<span class="kn">from</span> <span class="nn">langchain_core.tools</span> <span class="kn">import</span> <span class="n">BaseTool</span>

<span class="kn">from</span> <span class="nn">langchain.agents.agent</span> <span class="kn">import</span> <span class="n">AgentExecutor</span>
<span class="kn">from</span> <span class="nn">langchain.agents.agent_types</span> <span class="kn">import</span> <span class="n">AgentType</span>
<span class="kn">from</span> <span class="nn">langchain.agents.loading</span> <span class="kn">import</span> <span class="n">AGENT_TO_CLASS</span><span class="p">,</span> <span class="n">load_agent</span>

<span class="n">agent_cls</span> <span class="o">=</span> <span class="n">AGENT_TO_CLASS</span><span class="p">[</span><span class="n">AgentType</span><span class="o">.</span><span class="n">CONVERSATIONAL_REACT_DESCRIPTION</span><span class="p">]</span>
<span class="n">agent_kwargs</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">agent_obj</span> <span class="o">=</span> <span class="n">agent_cls</span><span class="o">.</span><span class="n">from_llm_and_tools</span><span class="p">(</span>
    <span class="n">llm</span><span class="p">,</span> <span class="n">tools</span><span class="p">,</span> <span class="n">callback_manager</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">agent_kwargs</span><span class="p">)</span>

<span class="n">agent_execute</span><span class="o">=</span><span class="n">AgentExecutor</span><span class="o">.</span><span class="n">from_agent_and_tools</span><span class="p">(</span>
        <span class="n">agent</span><span class="o">=</span><span class="n">agent_obj</span><span class="p">,</span>
        <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
        <span class="n">callback_manager</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">handle_parsing_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">output_key</span> <span class="o">=</span> <span class="s2">&quot;output&quot;</span><span class="p">,</span>
        <span class="n">max_iterations</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
        <span class="n">return_intermediate_steps</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">early_stopping_method</span><span class="o">=</span><span class="s2">&quot;generate&quot;</span><span class="p">,</span> <span class="c1"># or use **force**</span>
        <span class="n">memory</span><span class="o">=</span><span class="n">ConversationBufferMemory</span><span class="p">(</span><span class="n">memory_key</span><span class="o">=</span><span class="s2">&quot;chat_history&quot;</span><span class="p">,</span> <span class="n">input_key</span><span class="o">=</span><span class="s1">&#39;input&#39;</span><span class="p">,</span> <span class="n">output_key</span><span class="o">=</span><span class="s2">&quot;output&quot;</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="step-10-define-the-graph-state">
<h2>Step 10 - Define the graph state<a class="headerlink" href="#step-10-define-the-graph-state" title="Permalink to this headline"></a></h2>
<p>We now define the graph state. The state for the traditional LangChain agent has a few attributes:</p>
<ol class="arabic simple">
<li><p><code class="docutils literal notranslate"><span class="pre">input</span></code>: This is the input string representing the main ask from the user, passed in as input.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">chat_history</span></code>: This is any previous conversation messages, also passed in as input.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">intermediate_steps</span></code>: This is list of actions and corresponding observations that the agent takes over time. This is updated each iteration of the agent.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">agent_outcome</span></code>: This is the response from the agent, either an AgentAction or AgentFinish. The AgentExecutor should finish when this is an AgentFinish, otherwise it should call the requested tools.</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">TypedDict</span><span class="p">,</span> <span class="n">Annotated</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Union</span>
<span class="kn">from</span> <span class="nn">langchain_core.agents</span> <span class="kn">import</span> <span class="n">AgentAction</span><span class="p">,</span> <span class="n">AgentFinish</span>
<span class="kn">from</span> <span class="nn">langchain_core.messages</span> <span class="kn">import</span> <span class="n">BaseMessage</span>
<span class="kn">import</span> <span class="nn">operator</span>


<span class="k">class</span> <span class="nc">AgentState</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">):</span>
    <span class="c1"># The input string</span>
    <span class="nb">input</span><span class="p">:</span> <span class="nb">str</span>
    <span class="c1"># The list of previous messages in the conversation</span>
    <span class="n">chat_history</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">BaseMessage</span><span class="p">]</span>
    <span class="c1"># The outcome of a given call to the agent</span>
    <span class="c1"># Needs `None` as a valid type, since this is what this will start as</span>
    <span class="n">agent_outcome</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">AgentAction</span><span class="p">,</span> <span class="n">AgentFinish</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
    <span class="c1"># List of actions and corresponding observations</span>
    <span class="c1"># Here we annotate this with `operator.add` to indicate that operations to</span>
    <span class="c1"># this state should be ADDED to the existing values (not overwrite it)</span>
    <span class="n">intermediate_steps</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">AgentAction</span><span class="p">,</span> <span class="nb">str</span><span class="p">]],</span> <span class="n">operator</span><span class="o">.</span><span class="n">add</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="step-11-define-the-nodes">
<h2>Step 11 - Define the nodes<a class="headerlink" href="#step-11-define-the-nodes" title="Permalink to this headline"></a></h2>
<p>We now need to define a few different nodes in our graph.
In LangGraph, a node can be either a function or a <a class="reference external" href="https://python.langchain.com/docs/expression_language/">runnable</a>.
There are two main nodes we need for this:</p>
<ol class="arabic simple">
<li><p>The agent (<code class="docutils literal notranslate"><span class="pre">run_agent</span></code>): responsible for deciding what (if any) actions to take.</p></li>
<li><p>A function to invoke tools (<code class="docutils literal notranslate"><span class="pre">execute_tools</span></code>): if the agent decides to take an action, this node will then execute that action.</p></li>
</ol>
<p>We will also need to define some edges.
Some of these edges may be conditional.
The reason they are conditional is that based on the output of a node, one of several paths may be taken.
The path that is taken is not known until that node is run (the LLM decides).</p>
<ol class="arabic simple">
<li><p>Conditional Edge (<code class="docutils literal notranslate"><span class="pre">should_continue</span></code>): after the agent is called, we should either:</p>
<ul class="simple">
<li><p>If the agent said to take an action, then the function to invoke tools is called.</p></li>
<li><p>If the agent said that it was finished, then it finishes.</p></li>
</ul>
</li>
<li><p>Normal Edge: after the tools are invoked, it should always go back to the agent to decide what to do next.</p></li>
</ol>
<p>Let’s define the nodes, as well as a function to decide how what conditional edge to take.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Define the agent</span>
<span class="kn">from</span> <span class="nn">langchain_core.agents</span> <span class="kn">import</span> <span class="n">AgentActionMessageLog</span>

<span class="k">def</span> <span class="nf">run_agent</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="n">inputs</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;input&#39;</span><span class="p">]</span>
    <span class="n">agent_outcome</span> <span class="o">=</span> <span class="n">agent_execute</span><span class="o">.</span><span class="n">invoke</span><span class="p">({</span><span class="s2">&quot;input&quot;</span><span class="p">:</span><span class="n">text</span><span class="p">})</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;agent_outcome&quot;</span><span class="p">:</span> <span class="n">agent_outcome</span><span class="p">}</span>

<span class="c1"># Define the function to execute tools</span>
<span class="k">def</span> <span class="nf">execute_tools</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="c1"># Get the most recent agent_outcome - this is the key added in the `agent` above</span>
    <span class="n">agent_output</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;agent_outcome&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">agent_output</span><span class="p">[</span><span class="s1">&#39;intermediate_steps&#39;</span><span class="p">])</span><span class="o">&gt;=</span><span class="mi">1</span> <span class="p">:</span>
        <span class="n">agent_action</span> <span class="o">=</span> <span class="n">agent_output</span><span class="p">[</span><span class="s1">&#39;intermediate_steps&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">tool_executor</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">agent_action</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;intermediate_steps&quot;</span><span class="p">:</span> <span class="p">[(</span><span class="n">agent_action</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">output</span><span class="p">))]}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;intermediate_steps&quot;</span><span class="p">:[]}</span>

<span class="c1"># Define logic that is used to determine which conditional edge to go down</span>
<span class="k">def</span> <span class="nf">should_continue</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="c1"># If the agent outcome is an AgentFinish, then we return `exit` string</span>
    <span class="c1"># This will be used when setting up the graph to define the flow</span>
    <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;agent_outcome&quot;</span><span class="p">][</span><span class="s2">&quot;output&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; **AgentFinish** &quot;</span> <span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;end&quot;</span>
    <span class="c1"># Otherwise, an AgentAction is returned</span>
    <span class="c1"># Here we return `continue` string</span>
    <span class="c1"># This will be used when setting up the graph to define the flow</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; **continue** &quot;</span> <span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;continue&quot;</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="step-12-connect-the-nodes-with-edges-to-form-the-graph-let-s-call-it-app">
<h2>Step 12 - Connect the nodes with edges to form the graph, let’s call it <strong>app</strong><a class="headerlink" href="#step-12-connect-the-nodes-with-edges-to-form-the-graph-let-s-call-it-app" title="Permalink to this headline"></a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">langgraph.graph</span> <span class="kn">import</span> <span class="n">END</span><span class="p">,</span> <span class="n">StateGraph</span>

<span class="c1"># Define a new graph</span>
<span class="n">workflow</span> <span class="o">=</span> <span class="n">StateGraph</span><span class="p">(</span><span class="n">AgentState</span><span class="p">)</span>

<span class="c1"># Define the two nodes we will cycle between</span>
<span class="n">workflow</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s2">&quot;agent&quot;</span><span class="p">,</span> <span class="n">run_agent</span><span class="p">)</span>
<span class="n">workflow</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s2">&quot;action&quot;</span><span class="p">,</span> <span class="n">execute_tools</span><span class="p">)</span>

<span class="c1"># Set the entrypoint as `agent`</span>
<span class="c1"># This means that this node is the first one called</span>
<span class="n">workflow</span><span class="o">.</span><span class="n">set_entry_point</span><span class="p">(</span><span class="s2">&quot;agent&quot;</span><span class="p">)</span>

<span class="c1"># We now add a conditional edge</span>
<span class="n">workflow</span><span class="o">.</span><span class="n">add_conditional_edges</span><span class="p">(</span>
    <span class="c1"># First, we define the start node. We use `agent`.</span>
    <span class="c1"># This means these are the edges taken after the `agent` node is called.</span>
    <span class="s2">&quot;agent&quot;</span><span class="p">,</span>
    <span class="c1"># Next, we pass in the function that will determine which node is called next.</span>
    <span class="n">should_continue</span><span class="p">,</span>
    <span class="c1"># Finally we pass in a mapping.</span>
    <span class="c1"># The keys are strings, and the values are other nodes.</span>
    <span class="c1"># END is a special node marking that the graph should finish.</span>
    <span class="c1"># What will happen is we will call `should_continue`, and then the output of that</span>
    <span class="c1"># will be matched against the keys in this mapping.</span>
    <span class="c1"># Based on which one it matches, that node will then be called.</span>
    <span class="p">{</span>
        <span class="c1"># If `tools`, then we call the tool node.</span>
        <span class="s2">&quot;continue&quot;</span><span class="p">:</span> <span class="s2">&quot;action&quot;</span><span class="p">,</span>
        <span class="c1"># Otherwise we finish.</span>
        <span class="s2">&quot;end&quot;</span><span class="p">:</span> <span class="n">END</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">)</span>

<span class="c1"># We now add a normal edge from `tools` to `agent`.</span>
<span class="c1"># This means that after `tools` is called, `agent` node is called next.</span>
<span class="n">workflow</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s2">&quot;action&quot;</span><span class="p">,</span> <span class="s2">&quot;agent&quot;</span><span class="p">)</span>

<span class="c1"># Finally, we compile it!</span>
<span class="c1"># This compiles it into a LangChain Runnable,</span>
<span class="c1"># meaning you can use it as you would any other runnable</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">workflow</span><span class="o">.</span><span class="n">compile</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="step-13-time-to-test-it-out">
<h2>Step 13 - Time to test it out<a class="headerlink" href="#step-13-time-to-test-it-out" title="Permalink to this headline"></a></h2>
<p>Let’s start by seeing if we can trigger the retriever tool (tool name: AboutSweden).</p>
<p>Then, we will try to call the Wikipedia tool (tool name : Wiki).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">## first let&#39;s see if we can trigger our custom retriever tool named : AboutSweden</span>

<span class="n">inputs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;input&quot;</span><span class="p">:</span> <span class="s2">&quot;What is Sweden&#39;s population?&quot;</span><span class="p">}</span>
<span class="n">outputs</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">## let&#39;s see if we can trigger our Wikipedia tool named : Wiki</span>

<span class="n">inputs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;input&quot;</span><span class="p">:</span> <span class="s2">&quot;Find me Taylor Swift information on wiki?&quot;</span><span class="p">}</span>
<span class="n">outputs</span><span class="o">=</span><span class="n">app</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="05_RAG_for_HTML_docs_with_Langchain_NVIDIA_AI_Endpoints.html" class="btn btn-neutral float-left" title="Build a RAG chain by generating embeddings for NVIDIA Triton documentation" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="07_Chat_with_nvidia_financial_reports.html" class="btn btn-neutral float-right" title="Notebook: Chatting with NVIDIA Financial Reports" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023-2024, NVIDIA Corporation.</p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
 



</body>
</html>